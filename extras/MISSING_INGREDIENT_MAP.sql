--DROP TABLE #TEMP_CONCEPTS_MISSING_MAPS

/*FIND ITEMS MISSING MAPS IN OLD VOCAB, THERE ARE 10,939 in VOCAB 20170503*/
/*All 10,939 CONCEPTS EXIST IN VOCAB 20170920*/
WITH CTE_CONCEPT_ANCESTOR AS (
	SELECT c.CONCEPT_ID, c.CONCEPT_NAME, c.CONCEPT_CLASS_ID, c.VOCABULARY_ID, c.INVALID_REASON,
		c2.CONCEPT_ID AS DESCENDANT_CONCEPT_ID, c2.CONCEPT_NAME AS DESCENDANT_CONCEPT_NAME, 
		c2.CONCEPT_CLASS_ID AS DESCENDANT_CONCEPT_CLASS_ID, c2.INVALID_REASON AS DESCENDANT_INVALID_REASON
	FROM CDM.CONCEPT c
		JOIN CDM.CONCEPT_ANCESTOR ca
			ON ca.DESCENDANT_CONCEPT_ID = c.CONCEPT_ID
		JOIN CDM.CONCEPT c2
			ON c2.CONCEPT_ID = ca.ANCESTOR_CONCEPT_ID
	WHERE UPPER(c.DOMAIN_ID) = 'DRUG'
	AND UPPER(c.STANDARD_CONCEPT) = 'S'
), 
CTE_INGREDIENT_ONLY AS (
	SELECT *
	FROM CTE_CONCEPT_ANCESTOR
	WHERE DESCENDANT_CONCEPT_CLASS_ID = 'Ingredient'
)
SELECT DISTINCT ca1.CONCEPT_ID, ca1.CONCEPT_NAME, ca1.CONCEPT_CLASS_ID, ca1.VOCABULARY_ID, ca1.INVALID_REASON, 
	ca2.DESCENDANT_CONCEPT_ID, ca2.DESCENDANT_CONCEPT_NAME, ca2.DESCENDANT_CONCEPT_CLASS_ID, ca2.DESCENDANT_INVALID_REASON
INTO #TEMP_CONCEPTS_MISSING_MAPS
FROM CTE_CONCEPT_ANCESTOR ca1
	LEFT OUTER JOIN CTE_INGREDIENT_ONLY ca2
		ON ca1.CONCEPT_ID = ca2.CONCEPT_ID
WHERE ca2.DESCENDANT_CONCEPT_ID IS NULL
ORDER BY ca1.CONCEPT_NAME;

--CREATE INDEX IDX_TEMP_CONCEPTS_MISSING_MAPS_CONCEPT_ID ON #TEMP_CONCEPTS_MISSING_MAPS (CONCEPT_ID);

SELECT *
FROM #TEMP_CONCEPTS_MISSING_MAPS

WITH CTE_INGREDIENT AS (
	SELECT c.CONCEPT_ID AS INGREDIENT_CONCEPT_ID, c.CONCEPT_NAME AS INGREDIENT_CONCEPT_NAME, 
		m.*
	FROM #TEMP_CONCEPTS_MISSING_MAPS m
		JOIN VOCABULARY.CONCEPT_ANCESTOR ca
			ON ca.DESCENDANT_CONCEPT_ID = m.concept_id
		JOIN VOCABULARY.CONCEPT c
			On c.CONCEPT_ID = ca.ANCESTOR_CONCEPT_ID
			AND c.CONCEPT_CLASS_ID = 'Ingredient'
),
CTE_CODES AS ( 
  SELECT NULL AS INGREDIENT_CONCEPT_ID, NULL AS INGREDIENT_CONCEPT_NAME, 
  	m.*
  FROM #TEMP_CONCEPTS_MISSING_MAPS m
  WHERE m.concept_id NOT IN (
  	SELECT CONCEPT_ID FROM CTE_INGREDIENT
  )
  UNION ALL
  SELECT *
  FROM CTE_INGREDIENT
),
CTE_SUMMARIZE AS (
  SELECT c.INGREDIENT_CONCEPT_ID, c.INGREDIENT_CONCEPT_NAME, 
    c.CONCEPT_ID, c.CONCEPT_NAME, 
    c.CONCEPT_CLASS_ID, c.VOCABULARY_ID,  
    COUNT(DISTINCT de.PERSON_ID) AS PERSON_COUNT, 
    COUNT(de.PERSON_ID) AS ROW_COUNT
  FROM CTE_CODES c
    LEFT OUTER JOIN CDM.DRUG_EXPOSURE de
      ON de.DRUG_CONCEPT_ID = c.CONCEPT_ID
  GROUP BY c.INGREDIENT_CONCEPT_ID, c.INGREDIENT_CONCEPT_NAME, 
    c.CONCEPT_ID, c.CONCEPT_NAME, 
    c.CONCEPT_CLASS_ID, c.VOCABULARY_ID 
), 
CTE_TOTAL_INGREDIENT AS (
  SELECT ca.ANCESTOR_CONCEPT_ID AS INGREDIENT_CONCEPT_ID, 
      COUNT(DISTINCT de.PERSON_ID) AS TOTAL_PERSON_COUNT, 
      COUNT(de.PERSON_ID) AS TOTAL_ROW_COUNT
  FROM VOCABULARY.CONCEPT_ANCESTOR ca
    LEFT OUTER JOIN CDM.DRUG_EXPOSURE de
      ON de.DRUG_CONCEPT_ID = ca.DESCENDANT_CONCEPT_ID
  WHERE ca.ANCESTOR_CONCEPT_ID IN (
    SELECT DISTINCT c.INGREDIENT_CONCEPT_ID FROM CTE_SUMMARIZE c
  )
  GROUP BY ca.ANCESTOR_CONCEPT_ID
)
SELECT 
  CASE
    WHEN s.INGREDIENT_CONCEPT_ID IN (35603017,35605744,35604848,21014157,1107830,1790692,991876,1338985,1192710,1338512,1703653,937368,907553,903643,1794280,21602139,735843,918906,19039227,1301125,1336825,1321636,1549786,985708,1389464,1126658,19054825,1103552,1344992,735979,19085688,926487,1714319,739323,19097481,795113,745790,1154029,757627,1103314,911735,19086100,1521369,19059528,1703069,19047423,1350310,742267,715939,990340,924151,941472,907879,1503297,19037833,19045272,19050488,923081,1742253,1125315,950637,19037983,1710281,1594973,19055183,703244,40239330,40238930,19016749,705944,797617,1548195,766529,1394337,940864,43012518,40161532,43526465,44785086,19041065,44507580,42874220,44507848,19026459,19015523,1758536,44818461,1756831,19024728,40241331,40239056,1713905) THEN 1
    ELSE 0
  END AS JNJ_INGREDIENT, 
  s.*, 
  i.TOTAL_PERSON_COUNT, i.TOTAL_ROW_COUNT
FROM CTE_SUMMARIZE s
  LEFT OUTER JOIN CTE_TOTAL_INGREDIENT i
    ON i.INGREDIENT_CONCEPT_ID = s.INGREDIENT_CONCEPT_ID

  
